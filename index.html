<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lover Site ‚Äî Unified</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
    :root{
      --glass-bg: rgba(18,18,20,0.44);
      --accent: #e07a9a;
      --text-soft: #f6eef0;
      --muted: #d8cfd1;
      --card-shadow: 0 8px 32px rgba(3,4,10,0.6);
      --glow: 0 6px 30px rgba(255,255,255,0.06);
    }
    html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:#101018;color:var(--text-soft);}
    .page {position:relative;min-height:100vh;overflow:hidden;}
    .bg-layer {position:absolute;inset:0;z-index:0;transition:opacity 900ms ease;
      background:linear-gradient(90deg,#f48fb1 0%,#64b5f6 100%);filter:saturate(0.92) contrast(0.95) brightness(0.88);}
    .bg-breathe {position:absolute;inset:0;z-index:1;pointer-events:none;
      background:radial-gradient(1200px 600px at 20% 30%,rgba(255,255,255,0.02),transparent 15%),
                 radial-gradient(900px 600px at 80% 70%,rgba(255,255,255,0.01),transparent 12%);
      animation:breathe 8s ease-in-out infinite;mix-blend-mode:overlay;}
    @keyframes breathe {0%{opacity:.92;transform:scale(1);}50%{opacity:.98;transform:scale(1.01);}100%{opacity:.92;transform:scale(1);}}
    .content {position:relative;z-index:5;padding:28px 18px;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;box-sizing:border-box;}
    .glass {width:100%;max-width:980px;margin:28px auto;background:var(--glass-bg);
      border-radius:18px;padding:20px;box-shadow:var(--card-shadow);backdrop-filter:blur(10px) saturate(0.9);
      -webkit-backdrop-filter:blur(10px) saturate(0.9);border:1px solid rgba(255,255,255,0.04);color:var(--text-soft);}
    h1,h2,h3,h4,p,label,button{ text-shadow: var(--glow); }
    h1{margin:6px 0 12px;font-weight:600;letter-spacing:0.6px}
    p { margin:8px 0; color:var(--muted); font-weight:300; }
    .login-row { display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap; margin-top:8px; }
    input[type="password"], input[type="text"], input[type="file"], textarea {
      padding:10px 12px;border-radius:10px;border:none;outline:none;font-size:15px;
      background:rgba(255,255,255,0.03);color:var(--text-soft);box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);
    }
    button { padding:8px 16px;border-radius:10px;border:none;background:linear-gradient(180deg,var(--accent),#d86d8f); color:white;font-weight:600;cursor:pointer;box-shadow:0 6px 18px rgba(200,80,120,0.12);transition: transform 160ms ease, box-shadow 160ms ease;}
    button:hover{ transform: translateY(-3px); box-shadow:0 12px 36px rgba(200,80,120,0.12); }
    button.disabled { opacity: 0.5; cursor: not-allowed; }
    button.shake { animation: shake 0.5s; }
    @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
    .pop { animation: pop 0.2s; }
    @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    .tabs {display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;justify-content:center;}
    .tab {background:rgba(255,255,255,0.03);border-radius:10px;padding:8px 12px;cursor:pointer;border:1px solid rgba(255,255,255,0.04);}
    .tab.active{box-shadow:0 8px 28px rgba(0,0,0,0.45);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));}
    .grid {display:grid;grid-template-columns:1fr 360px;gap:14px;align-items:start;}
    .panel {background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);}
    .profile-row{display:flex;gap:12px;align-items:center;}
    .small{font-size:13px;color:var(--muted);}
    .swatch { width:44px;height:28px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);box-shadow:inset 0 1px 0 rgba(255,255,255,0.02); }
    .gallery {display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;}
    .gallery img{width:100%;height:100px;object-fit:cover;border-radius:8px;cursor:pointer;display:block;}
    .memory-item{border-radius:8px;padding:8px;background:rgba(255,255,255,0.02);margin-bottom:8px;}
    .chat-window{height:360px;overflow:auto;padding:8px;border-radius:8px;background:rgba(0,0,0,0.12);display:flex;flex-direction:column;gap:8px;}
    .message{display:flex;gap:8px;align-items:flex-end;}
    .message.me{justify-content:flex-end;}
    .message .bubble{max-width:70%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.03);color:var(--text-soft);box-shadow:0 6px 20px rgba(0,0,0,0.45);}
    .message.me .bubble{background:linear-gradient(180deg,#ff9db0,#e07a9a);color:#111;}
    .message img.msg-img{width:160px;height:100px;object-fit:cover;border-radius:8px;display:block;}
    .typing {font-size:13px;color:var(--muted);margin-top:6px;transition: opacity 0.3s ease;}
    .typing.hidden { opacity: 0; }
    .controls{display:flex;gap:8px;align-items:center;margin-top:8px;}
    .hidden{display:none;}
    footer{margin-top:12px;font-size:13px;color:rgba(255,255,255,0.6);text-align:center;}
    @media (max-width:980px){ .grid{grid-template-columns:1fr;} .glass{padding:16px;} .chat-window{height:280px;} }
    .cooldown { font-size: 12px; color: var(--accent); }
    .online { color: #5fbf6b; }
    .offline { color: #b94a4a; }
    .global-typing { position: fixed; bottom: 50px; right: 14px; background: rgba(255,255,255,0.03); padding: 6px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.03); transition: opacity 0.3s ease; }
    .global-typing.hidden { opacity: 0; pointer-events: none; }
  </style>
</head>
<body>
  <div class="page">
    <div id="bg-main" class="bg-layer"></div>
    <div class="bg-breathe" aria-hidden="true"></div>
    <main class="content">
      <section class="glass" id="loginCard">
        <h2>Welcome ‚Äî Safe Space</h2>
        <p>Enter the secret password to enter and choose who you are.</p>
        <div class="login-row">
          <input id="passwordInput" type="password" placeholder="Password" />
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="rememberMe"> Remember me
          </label>
          <button id="enterBtn">Enter</button>
        </div>
        <p class="small">After entering the password you'll pick either <strong>Logan</strong> or <strong>Ezekiel</strong>.</p>
      </section>
      <section class="glass reveal hidden" id="mainContent">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div>
            <h1>Lover Site / Safe Space</h1>
            <p class="small"><strong>Anniversary:</strong> November 2 ¬∑ <span id="countdown"></span></p>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <div id="userBadge" class="small"></div>
            <div id="presenceStatus" class="small"></div>
            <button id="logoutBtn" style="background:rgba(255,255,255,0.05);padding:6px 10px;border-radius:10px;font-size:14px;">Logout</button>
          </div>
        </div>
        <div class="tabs" role="tablist" aria-label="Main navigation">
          <div class="tab active" data-tab="dashboard">Dashboard</div>
          <div class="tab" data-tab="chat">Chat</div>
          <div class="tab" data-tab="memories">Memory Bank</div>
          <div class="tab" data-tab="profile">Profile</div>
          <div class="tab" data-tab="quotes">Quotes & Challenges</div>
        </div>
        <div class="grid" style="margin-top:12px;">
          <!-- MAIN COLUMN -->
          <div>
            <!-- DASHBOARD -->
            <div id="tab-dashboard" class="panel tabPanel">
              <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap;">
                <div style="display:flex;gap:12px;align-items:center;">
                  <div>
                    <div id="leftName" style="font-weight:600">‚Äî</div>
                    <div id="leftPet" class="small"></div>
                    <div id="leftEmotion" class="small"></div>
                  </div>
                </div>
                <div style="display:flex;gap:12px;align-items:center;">
                  <div>
                    <div id="rightName" style="font-weight:600;text-align:right">‚Äî</div>
                    <div id="rightPet" class="small" style="text-align:right"></div>
                    <div id="rightEmotion" class="small" style="text-align:right"></div>
                  </div>
                </div>
              </div>
              <div style="margin-top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center;">
                <button id="openNoteBtn">‚òÖ Shared Note</button>
                <button id="openNewMemoryBtn" style="background:rgba(255,255,255,0.03);color:var(--text-soft);border:1px solid rgba(255,255,255,0.04);">Add Text Memory</button>
              </div>
              <div style="margin-top:12px;">
                <h3 style="margin:6px 0">Quote of the Day</h3>
                <p id="quote" style="font-style:italic;"></p>
                <h3 style="margin-top:12px;">Daily Challenge</h3>
                <div id="dailyChallenge" style="margin-bottom:6px;font-weight:400;color:var(--muted);"></div>
              </div>
            </div>
            <!-- CHAT -->
            <div id="tab-chat" class="panel tabPanel hidden">
              <h3 style="margin:6px 0 10px 0;">Chat</h3>
              <div class="chat-window" id="chatWindow" aria-live="polite"></div>
              <div class="typing" id="typingStatus"></div>
              <div class="controls">
                <input id="chatInput" type="text" placeholder="Type a message..." style="flex:1;">
                <input id="chatImageInput" type="file" accept="image/*" class="hidden">
                <button id="pickImageBtn" title="Attach image">üñºÔ∏è</button>
                <button id="recordBtn" title="Record voice message">üéôÔ∏è</button>
                <button id="sendBtn">Send</button>
              </div>
              <div id="recIndicator" class="small hidden">Recording‚Ä¶ <button id="stopRecBtn">Stop</button></div>
            </div>
            <!-- MEMORY BANK -->
            <div id="tab-memories" class="panel tabPanel hidden">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <h3 style="margin:6px 0">Memory Bank</h3>
                <button id="addMemoryBtn" style="background:rgba(255,255,255,0.03)">New Memory</button>
              </div>
              <div id="memoriesList" style="margin-top:10px"></div>
            </div>
            <!-- PROFILE -->
            <div id="tab-profile" class="panel tabPanel hidden">
              <h3 style="margin:6px 0">Profile & Preferences</h3>
              <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
                <div class="profile-row">
                  <div>
                    <div><strong id="displayName">‚Äî</strong></div>
                    <div class="small">Pet name for them: <span id="myPetPreview"></span></div>
                  </div>
                </div>
              </div>
              <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
                <div>
                  <label class="small">Set Pet Name For Them</label><br>
                  <input id="petNameInput" placeholder="Sweetheart">
                  <button id="savePetBtn">Save</button>
                </div>
                <div>
                  <label class="small">Set Emotion / Mood</label><br>
                  <select id="emotionSelect">
                    <option value="">‚Äî choose mood ‚Äî</option>
                    <option value="happy">Happy</option>
                    <option value="sad">Sad</option>
                    <option value="upset">Upset / Angry</option>
                    <option value="depressed">Depressed</option>
                    <option value="concerned">Concerned / Worried</option>
                    <option value="frightened">Frightened / Afraid</option>
                    <option value="lovey">Lovey</option>
                    <option value="romantic">Romantic</option>
                    <option value="annoyed">Annoyed</option>
                    <option value="dominant">Dominant</option>
                    <option value="submissive">Submissive</option>
                    <option value="attention">Attention</option>
                    <option value="desperate">Desperate</option>
                  </select>
                </div>
                <div>
                  <label class="small">Choose Local Display Name</label><br>
                  <input id="localNameInput" placeholder="Logan or Ezekiel">
                  <button id="saveLocalNameBtn">Save</button>
                </div>
                <div>
                  <label class="small">Sound Volume</label><br>
                  <input id="volumeSlider" type="range" min="0" max="1" step="0.1" value="1">
                  <span id="volumeValue">100%</span>
                </div>
              </div>
            </div>
            <!-- Quotes & Challenges -->
            <div id="tab-quotes" class="panel tabPanel hidden">
              <h3 style="margin:6px 0">Quotes & Challenges</h3>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <input id="newQuoteInput" placeholder="Add a new quote" style="flex:1">
                <button id="addQuoteBtn">Add Quote</button>
              </div>
              <div id="quotesList" style="margin-top:8px"></div>
              <hr style="margin:10px 0;border-color:rgba(255,255,255,0.03)">
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <input id="newChallengeInput" placeholder="Add a new challenge" style="flex:1">
                <button id="addChallengeBtn">Add Challenge</button>
              </div>
              <div id="challengesList" style="margin-top:8px"></div>
            </div>
          </div>
          <!-- RIGHT COLUMN -->
          <div>
            <div class="panel">
              <div style="display:flex;gap:12px;align-items:center;">
                <div>
                  <div id="meGreeting" style="font-weight:600">‚Äî</div>
                  <div class="small" id="meSub">Your space</div>
                </div>
              </div>
              <div style="margin-top:12px;">
                <div style="margin-top:12px;">
                  <h4 style="margin:6px 0">Colors</h4>
                  <div style="display:flex;gap:8px;align-items:center;">
                    <div class="label">Logan</div><div id="loganSwatch" class="swatch"></div>
                  </div>
                  <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
                    <div class="label">Ezekiel</div><div id="ezekielSwatch" class="swatch"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="panel" style="margin-top:12px;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <h4 style="margin:6px 0">Shared Note</h4>
                <button id="openNoteBtn2" style="background:rgba(255,255,255,0.03)">Open</button>
              </div>
              <div id="notePreview" style="color:var(--muted);min-height:44px;margin-top:6px">(No shared note yet ‚Äî click Open)</div>
            </div>
            <div class="panel" style="margin-top:12px;">
              <h4 style="margin:6px 0">Quick Controls</h4>
              <div style="display:flex;flex-direction:column;gap:8px;">
                <button id="goToChat" style="background:rgba(255,255,255,0.03)">Open Chat</button>
                <button id="goToProfile" style="background:rgba(255,255,255,0.03)">Profile</button>
                <button id="testBtn" style="background:rgba(255,255,255,0.03)">Test (1 click)</button>
                <button id="bedBtn" style="background:rgba(255,255,255,0.03)">Bed (2 clicks)</button>
                <button id="kneesBtn" style="background:rgba(255,255,255,0.03)">On Knees (3 clicks)</button>
                <button id="puppyBtn" style="background:rgba(255,255,255,0.03)">Puppy (5 clicks)</button>
              </div>
            </div>
          </div>
        </div>
        <footer>Safe Space ‚Äî built for you two ‚ô•</footer>
      </section>
    </main>
  </div>
  <!-- Shared Note Modal -->
  <div id="modalBackdrop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:10000;align-items:center;justify-content:center;">
    <div style="width:min(760px,94%);background:rgba(10,10,12,0.97);border-radius:12px;padding:14px;box-shadow:0 12px 40px rgba(0,0,0,0.6);color:var(--text-soft);">
      <h3 style="margin:0 0 8px 0;">Shared Note</h3>
      <textarea id="sharedNoteTextarea" placeholder="Write something sweet, a memory, a plan..." style="width:100%;height:160px;border-radius:10px;padding:12px;background:rgba(255,255,255,0.03);color:var(--text-soft);border:1px solid rgba(255,255,255,0.04);"></textarea>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px;">
        <button id="saveNoteBtn">Save</button>
        <button id="closeNoteBtn">Close</button>
      </div>
      <div style="margin-top:8px;font-size:13px;color:var(--muted)">Saved automatically while you type (debounced).</div>
    </div>
  </div>
  <!-- Image Lightbox -->
  <div id="lightbox" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:12000;align-items:center;justify-content:center;padding:20px;">
    <div style="max-width:92%;max-height:92%;"><img id="lightboxImg" src="" style="max-width:100%;max-height:100%;border-radius:12px;display:block"></div>
  </div>
  <div id="status" style="position:fixed;bottom:14px;right:14px;display:flex;gap:8px;align-items:center;z-index:9999;color:var(--muted);background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);">
    <div id="statusDotSmall" style="width:10px;height:10px;border-radius:50%;background:#b94a4a;"></div>
    <div id="statusTextSmall">Connecting...</div>
  </div>
  <div id="globalTyping" class="global-typing hidden"></div>
  <script type="module">
    // Firebase imports (Realtime DB + Storage)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";
    const firebaseConfig = {
      apiKey: "AIzaSyAPR-TAnTSg7D2dkVjBU8SPBtTEtiztcsI",
      authDomain: "ezekiellogancolors.firebaseapp.com",
      databaseURL: "https://ezekiellogancolors-default-rtdb.firebaseio.com",
      projectId: "ezekiellogancolors",
      storageBucket: "ezekiellogancolors.appspot.com",
      messagingSenderId: "162262132243",
      appId: "1:162262132243:web:3c69771b68c9dc702b452b"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);
    // ELEMENTS
    const passwordInput = document.getElementById("passwordInput");
    const enterBtn = document.getElementById("enterBtn");
    const loginCard = document.getElementById("loginCard");
    const mainContent = document.getElementById("mainContent");
    const rememberMe = document.getElementById("rememberMe");
    const logoutBtn = document.getElementById("logoutBtn");
    const bgMain = document.getElementById("bg-main");
    const loganSwatch = document.getElementById("loganSwatch");
    const ezekielSwatch = document.getElementById("ezekielSwatch");
    const quoteEl = document.getElementById("quote");
    const challengeEl = document.getElementById("dailyChallenge");
    const countdownEl = document.getElementById("countdown");
    const notePreview = document.getElementById("notePreview");
    const openNoteBtn = document.getElementById("openNoteBtn");
    const openNoteBtn2 = document.getElementById("openNoteBtn2");
    const modalBackdrop = document.getElementById("modalBackdrop");
    const textarea = document.getElementById("sharedNoteTextarea");
    const closeNoteBtn = document.getElementById("closeNoteBtn");
    const saveNoteBtn = document.getElementById("saveNoteBtn");
    const statusEl = document.getElementById("status");
    const statusText = document.getElementById("statusTextSmall");
    const statusDot = document.getElementById("statusDotSmall");
    const tabs = document.querySelectorAll(".tab");
    const tabPanels = document.querySelectorAll(".tabPanel");
    const userBadge = document.getElementById("userBadge");
    const meGreeting = document.getElementById("meGreeting");
    const meAvatarSmall = document.getElementById("meAvatarSmall");
    // Profile inputs
    const petNameInput = document.getElementById("petNameInput");
    const savePetBtn = document.getElementById("savePetBtn");
    const emotionSelect = document.getElementById("emotionSelect");
    const localNameInput = document.getElementById("localNameInput");
    const saveLocalNameBtn = document.getElementById("saveLocalNameBtn");
    const volumeSlider = document.getElementById("volumeSlider");
    const volumeValue = document.getElementById("volumeValue");
    // Other UI
    const openNewMemoryBtn = document.getElementById("openNewMemoryBtn");
    const memoriesList = document.getElementById("memoriesList");
    const addMemoryBtn = document.getElementById("addMemoryBtn");
    // Quotes & challenges
    const newQuoteInput = document.getElementById("newQuoteInput");
    const addQuoteBtn = document.getElementById("addQuoteBtn");
    const quotesList = document.getElementById("quotesList");
    const newChallengeInput = document.getElementById("newChallengeInput");
    const addChallengeBtn = document.getElementById("addChallengeBtn");
    const challengesList = document.getElementById("challengesList");
    // Chat
    const chatWindow = document.getElementById("chatWindow");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");
    const pickImageBtn = document.getElementById("pickImageBtn");
    const chatImageInput = document.getElementById("chatImageInput");
    const recordBtn = document.getElementById("recordBtn");
    const recIndicator = document.getElementById("recIndicator");
    const stopRecBtn = document.getElementById("stopRecBtn");
    const typingStatus = document.getElementById("typingStatus");
    // avatars and dashboard
    const leftName = document.getElementById("leftName");
    const leftPet = document.getElementById("leftPet");
    const leftEmotion = document.getElementById("leftEmotion");
    const rightName = document.getElementById("rightName");
    const rightPet = document.getElementById("rightPet");
    const rightEmotion = document.getElementById("rightEmotion");
    const meGreetingEl = document.getElementById("meGreeting");
    const displayNameEl = document.getElementById("displayName");
    const myPetPreview = document.getElementById("myPetPreview");
    // Lightbox
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightboxImg");
    // Dog clicker buttons
    const testBtn = document.getElementById("testBtn");
    const bedBtn = document.getElementById("bedBtn");
    const kneesBtn = document.getElementById("kneesBtn");
    const puppyBtn = document.getElementById("puppyBtn");
    // Global typing
    const globalTyping = document.getElementById("globalTyping");
    // Presence
    const presenceStatus = document.getElementById("presenceStatus");
    // constants & mappings
    const PASSWORD = "Z+L-Forever";
    const USERS = ["logan", "ezekiel"];
    const EMOTION_MAP = {
      happy: { hex: "#FFE066", label: "Happy", emoji: "üòä" },
      sad: { hex: "#64b5f6", label: "Sad", emoji: "üòî" },
      upset: { hex: "#e57373", label: "Upset / Angry", emoji: "üò°" },
      depressed: { hex: "#455a64", label: "Depressed", emoji: "üñ§" },
      concerned: { hex: "#ffcc80", label: "Concerned / Worried", emoji: "üòü" },
      frightened: { hex: "#90caf9", label: "Frightened / Afraid", emoji: "üò®" },
      lovey: { hex: "#81d4fa", label: "Lovey", emoji: "ü•∞" },
      romantic: { hex: "#f48fb1", label: "Romantic", emoji: "üíó" },
      annoyed: { hex: "#8d6e63", label: "Annoyed", emoji: "üòí" },
      dominant: { hex: "#ef5350", label: "Dominant", emoji: "üî•" },
      submissive: { hex: "#81c784", label: "Submissive", emoji: "üõèÔ∏è" },
      attention: { hex: "#64b5f6", label: "Attention", emoji: "üëÄ" },
      desperate: { hex: "#ba68c8", label: "Desperate", emoji: "üí´" }
    };
    const CLICK_SOUND_URL = 'https://www.myinstants.com/media/sounds/dog-clicker_IygBqAk.mp3';
    // Preload sound
    const clickAudioPreload = new Audio(CLICK_SOUND_URL);
    clickAudioPreload.load();
    // local app state
    let me = null; // "logan" or "ezekiel"
    let myDisplayName = "";
    let mediaRecorder = null;
    let recordedChunks = [];
    let typingTimer = null;
    let lastClickTs = 0;
    let localVolume = 1.0;
    const COOLDOWN_TIME = 5; // seconds
    let cooldownTimers = {}; // per button
    // SIMPLE NAV
    tabs.forEach(t => t.addEventListener("click", () => {
      tabs.forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      const which = t.dataset.tab;
      tabPanels.forEach(p => p.classList.add("hidden"));
      document.getElementById("tab-" + which).classList.remove("hidden");
      // autofocus for chat input
      if (which === "chat") chatInput.focus();
    }));
    // small nav shortcuts
    document.getElementById("goToChat").addEventListener("click", () => document.querySelector('.tab[data-tab="chat"]').click());
    document.getElementById("goToProfile").addEventListener("click", () => document.querySelector('.tab[data-tab="profile"]').click());
    // LIGHTBOX
    lightbox.addEventListener("click", () => lightbox.style.display = "none");
    // AUTH (simple password + pick identity)
    window.addEventListener("load", () => {
      if (localStorage.getItem("rememberZL") === "true" && localStorage.getItem("zlUser")) {
        me = localStorage.getItem("zlUser");
        myDisplayName = localStorage.getItem("zlDisplayName") || (me === "logan" ? "Logan" : "Ezekiel");
        localVolume = parseFloat(localStorage.getItem(`zlVolume_${me}`)) || 1.0;
        showMain();
      }
    });
    enterBtn.addEventListener("click", async () => {
      const entered = passwordInput.value.trim();
      if (entered === PASSWORD) {
        // choose identity modal (simple prompt so it remains single-file)
        let pick = localStorage.getItem("zlUser");
        if (!pick) {
          pick = prompt("Who are you? Type 'Logan' or 'Ezekiel'").toLowerCase();
        }
        if (!["logan","ezekiel"].includes(pick)) {
          alert("Please enter 'Logan' or 'Ezekiel' to continue.");
          return;
        }
        me = pick;
        myDisplayName = pick === "logan" ? "Logan" : "Ezekiel";
        localVolume = parseFloat(localStorage.getItem(`zlVolume_${me}`)) || 1.0;
        if (rememberMe.checked) localStorage.setItem("rememberZL","true");
        localStorage.setItem("zlUser", me);
        localStorage.setItem("zlDisplayName", myDisplayName);
        showMain();
      } else {
        alert("Wrong password! üíî Try again.");
      }
    });
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("rememberZL");
      localStorage.removeItem("zlUser");
      localStorage.removeItem("zlDisplayName");
      USERS.forEach(u => localStorage.removeItem(`zlVolume_${u}`));
      location.reload();
    });
    function showMain() {
      loginCard.style.display = "none";
      mainContent.classList.remove("hidden");
      initFirebaseSync();
      loadQuote();
      loadChallenge();
      updateCountdown();
      statusConnected();
      displayLocalBasics();
      initClicker();
      initVolume();
      setupPresence();
    }
    // STATUS
    function statusConnected() {
      statusText.textContent = "Connected";
      statusDot.style.background = "#5fbf6b";
      document.getElementById("statusTextSmall").textContent = "Connected";
      document.getElementById("statusDotSmall").style.background = "#5fbf6b";
    }
    // Basic UI display
    function displayLocalBasics() {
      userBadge.textContent = `${me ? me.charAt(0).toUpperCase() + me.slice(1) : ""}`;
      meGreeting.innerText = `Hi ${myDisplayName || (me && me.charAt(0).toUpperCase()+me.slice(1))}!`;
      displayNameEl.textContent = myDisplayName || (me && me.charAt(0).toUpperCase()+me.slice(1));
    }
    // COUNTDOWN
    function updateCountdown() {
      const now = new Date();
      const currentYear = now.getFullYear();
      let next = new Date(`${currentYear}-11-02T00:00:00`);
      if (now > next) next = new Date(`${currentYear + 1}-11-02T00:00:00`);
      const diff = next - now;
      const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
      countdownEl.textContent = `${days} day${days !== 1 ? "s" : ""} until our anniversary üíû`;
    }
    // FIREBASE SYNC: colors, avatars, notes, gallery, memories, chat, quotes, challenges
    function initFirebaseSync() {
      // Colors & basic profile
      onValue(ref(db, "profiles"), (snap) => {
        const data = snap.val() || {};
        // ensure defaults exist
        USERS.forEach(u => {
          const profile = (data[u] || {});
          // name, petForOther, avatarUrl, emotion, color (derived), displayName
          document.getElementById(u === "logan" ? "leftName" : "rightName").textContent = profile.displayName || (u === "logan" ? "Logan" : "Ezekiel");
          document.getElementById(u === "logan" ? "leftPet" : "rightPet").textContent = profile.petName ? `Calls them: ${profile.petName}` : "";
          document.getElementById(u === "logan" ? "leftEmotion" : "rightEmotion").textContent = profile.emotion ? `${EMOTION_MAP[profile.emotion]?.emoji || ""} ${EMOTION_MAP[profile.emotion]?.label || profile.emotion}` : "";
          // swatches color by emotion hex
          const hex = profile.emotion ? (EMOTION_MAP[profile.emotion]?.hex || "#444") : "#444";
          if (u === "logan") loganSwatch.style.background = hex;
          if (u === "ezekiel") ezekielSwatch.style.background = hex;
        });
        // update background blend using both colors
        const logHex = data.logan?.emotion ? (EMOTION_MAP[data.logan.emotion]?.hex || "#f48fb1") : "#f48fb1";
        const ezHex = data.ezekiel?.emotion ? (EMOTION_MAP[data.ezekiel.emotion]?.hex || "#64b5f6") : "#64b5f6";
        bgMain.style.background = `linear-gradient(90deg, ${logHex} 0%, ${ezHex} 100%)`;
      });
      // Shared note
      onValue(ref(db, "sharedNote"), (snap) => {
        const note = snap.val() || "";
        textarea.value = note;
        notePreview.textContent = note ? note : "(No shared note yet ‚Äî click the ‚òÖ to add)";
      });
      // Memories
      onValue(ref(db, "memories"), (snap) => {
        const items = snap.val() || {};
        renderMemories(items);
      });
      // chat messages
      onValue(ref(db, "chat/messages"), (snap) => {
        const msgs = snap.val() || {};
        renderChat(msgs);
      });
      // typing status
      onValue(ref(db, "chat/typing"), (snap) => {
        const typing = snap.val() || {};
        const other = me === "logan" ? "ezekiel" : "logan";
        const isTyping = typing[other];
        const typingText = `${other.charAt(0).toUpperCase() + other.slice(1)} is typing‚Ä¶`;
        if (isTyping) {
          typingStatus.textContent = typingText;
          typingStatus.classList.remove("hidden");
          globalTyping.textContent = typingText;
          globalTyping.classList.remove("hidden");
        } else {
          typingStatus.textContent = "";
          typingStatus.classList.add("hidden");
          globalTyping.textContent = "";
          globalTyping.classList.add("hidden");
        }
      });
      // quotes and challenges
      onValue(ref(db, "quotes"), (snap) => {
        const q = snap.val() || {};
        renderQuotes(q);
      });
      onValue(ref(db, "challenges"), (snap) => {
        const c = snap.val() || {};
        renderChallenges(c);
      });
      // clicker command
      onValue(ref(db, "clicker/command"), (snap) => {
        const cmd = snap.val();
        if (cmd && cmd.ts > lastClickTs && me !== cmd.sender) {
          lastClickTs = cmd.ts;
          switch(cmd.type) {
            case "test": playClicks(1); break;
            case "bed": playClicks(2); break;
            case "knees": playClicks(3); break;
            case "puppy": playClicks(5); break;
          }
        }
      });
      // presence
      onValue(ref(db, "presence"), (snap) => {
        const pres = snap.val() || {};
        const other = me === "logan" ? "ezekiel" : "logan";
        const otherStatus = pres[other] ? "üü¢ Online" : "üî¥ Offline";
        presenceStatus.innerHTML = `<span class="${pres[other] ? 'online' : 'offline'}">${other.charAt(0).toUpperCase() + other.slice(1)}: ${otherStatus}</span>`;
      });
    }
    // SHARED NOTE logic (debounced)
    let noteTimeout;
    openNoteBtn.addEventListener("click", () => {
      modalBackdrop.style.display = "flex";
      textarea.focus();
    });
    openNoteBtn2.addEventListener("click", () => {
      modalBackdrop.style.display = "flex";
      textarea.focus();
    });
    closeNoteBtn.addEventListener("click", () => modalBackdrop.style.display = "none");
    saveNoteBtn.addEventListener("click", saveNote);
    textarea.addEventListener("input", () => {
      clearTimeout(noteTimeout);
      noteTimeout = setTimeout(saveNote, 700);
    });
    function saveNote() {
      set(ref(db, "sharedNote"), textarea.value);
    }
    savePetBtn.addEventListener("click", () => {
      const pet = petNameInput.value.trim();
      update(ref(db, `profiles/${me}`), { petName: pet }).then(() => {
        myPetPreview.textContent = pet;
      });
    });
    saveLocalNameBtn.addEventListener("click", () => {
      myDisplayName = localNameInput.value.trim() || (me && me.charAt(0).toUpperCase()+me.slice(1));
      update(ref(db, `profiles/${me}`), { displayName: myDisplayName });
      displayNameEl.textContent = myDisplayName;
      localStorage.setItem("zlDisplayName", myDisplayName);
    });
    emotionSelect.addEventListener("change", () => {
      const emo = emotionSelect.value;
      update(ref(db, `profiles/${me}`), { emotion: emo || "" });
    });
    // MEMORY BANK: add text memory
    openNewMemoryBtn.addEventListener("click", () => openMemoryModal());
    addMemoryBtn.addEventListener("click", () => openMemoryModal());
    function openMemoryModal(existingKey, existing) {
      const title = prompt("Memory title:", existing ? existing.title : "");
      if (!title) return;
      const body = prompt("Memory text:", existing ? existing.text : "");
      if (body === null) return;
      const category = prompt("Category (sweet / milestone / goofy / other):", existing ? existing.category : "sweet");
      const item = { title, text: body, category: category || "other", author: me, ts: Date.now() };
      if (existingKey) {
        update(ref(db, `memories/${existingKey}`), item);
      } else {
        const key = push(ref(db, "memories")).key;
        const updates = {};
        updates[`memories/${key}`] = item;
        update(ref(db), updates);
      }
    }
    function renderMemories(items) {
      memoriesList.innerHTML = "";
      const arr = Object.entries(items).sort((a,b)=>b[1].ts - a[1].ts);
      arr.forEach(([k,v]) => {
        const el = document.createElement("div");
        el.className = "memory-item";
        el.innerHTML = `<div style="display:flex;justify-content:space-between;"><strong>${v.title}</strong><div class="small">${new Date(v.ts).toLocaleDateString()}</div></div>
                        <div class="small" style="margin-top:6px">${v.text}</div>
                        <div style="display:flex;gap:8px;margin-top:8px;">
                          <button data-key="${k}" class="editMem">Edit</button>
                          <button data-key="${k}" class="delMem" style="background:rgba(255,255,255,0.03)">Delete</button>
                        </div>`;
        memoriesList.appendChild(el);
      });
      // events
      document.querySelectorAll(".editMem").forEach(btn => {
        btn.addEventListener("click", () => {
          const key = btn.dataset.key;
          const mem = items[key];
          openMemoryModal(key, mem);
        });
      });
      document.querySelectorAll(".delMem").forEach(btn => {
        btn.addEventListener("click", () => {
          const key = btn.dataset.key;
          if (confirm("Delete this memory?")) remove(ref(db, `memories/${key}`));
        });
      });
    }
    // CHAT: send text, image, voice; typing indicator
    sendBtn.addEventListener("click", sendChat);
    chatInput.addEventListener("keydown", (e) => {
      showTyping(true);
      if (typingTimer) clearTimeout(typingTimer);
      typingTimer = setTimeout(()=> showTyping(false), 800);
      if (e.key === "Enter") {
        e.preventDefault();
        sendChat();
      }
    });
    pickImageBtn.addEventListener("click", () => chatImageInput.click());
    chatImageInput.addEventListener("change", async (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const path = `chat_images/${me}/${Date.now()}_${f.name}`;
      const storageRef = sref(storage, path);
      await uploadBytes(storageRef, f);
      const url = await getDownloadURL(storageRef);
      postMessage({ type: "image", url });
    });
    // Voice recording (MediaRecorder)
    recordBtn.addEventListener("click", async () => {
      if (mediaRecorder && mediaRecorder.state === "recording") return;
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true }).catch(()=>null);
      if (!stream) { alert("Microphone access denied."); return; }
      recordedChunks = [];
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = (e) => { if (e.data.size) recordedChunks.push(e.data); };
      mediaRecorder.onstop = async () => {
        const blob = new Blob(recordedChunks, { type: "audio/webm" });
        const path = `chat_audio/${me}/${Date.now()}.webm`;
        const storageRef = sref(storage, path);
        await uploadBytes(storageRef, blob);
        const url = await getDownloadURL(storageRef);
        postMessage({ type: "audio", url });
        recIndicator.classList.add("hidden");
      };
      mediaRecorder.start();
      recIndicator.classList.remove("hidden");
    });
    stopRecBtn.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") mediaRecorder.stop();
    });
    function showTyping(val) {
      update(ref(db, `chat/typing/${me}`), val ? true : null); // set true or null to remove
      if (!val) update(ref(db, `chat/typing/${me}`), null);
    }
    async function sendChat() {
      const txt = chatInput.value.trim();
      if (!txt) return;
      postMessage({ type: "text", text: txt });
      chatInput.value = "";
      showTyping(false);
    }
    function postMessage(payload) {
      const data = {
        author: me,
        ts: Date.now(),
        ...payload
      };
      const key = push(ref(db, "chat/messages")).key;
      const updates = {};
      updates[`chat/messages/${key}`] = data;
      update(ref(db), updates);
    }
    function renderChat(msgs) {
      // msgs is object
      chatWindow.innerHTML = "";
      const arr = Object.entries(msgs).sort((a,b)=>a[1].ts - b[1].ts);
      arr.forEach(([k,v]) => {
        const wrapper = document.createElement("div");
        wrapper.className = "message " + (v.author === me ? "me" : "them");
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        // content
        if (v.type === "image") {
          bubble.innerHTML = `<img class="msg-img" src="${v.url}" alt="image">`;
          bubble.querySelector("img").addEventListener("click", () => {
            lightboxImg.src = v.url;
            lightbox.style.display = "flex";
          });
        } else if (v.type === "audio") {
          bubble.innerHTML = `<audio controls src="${v.url}"></audio>`;
        } else {
          bubble.innerText = v.text || "";
        }
        wrapper.appendChild(bubble);
        chatWindow.appendChild(wrapper);
      });
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    // QUOTES & CHALLENGES: add/remove
    addQuoteBtn.addEventListener("click", () => {
      const txt = newQuoteInput.value.trim();
      if (!txt) return;
      const key = push(ref(db, "quotes")).key;
      const updates = {};
      updates[`quotes/${key}`] = { text: txt, author: me, ts: Date.now() };
      update(ref(db), updates);
      newQuoteInput.value = "";
    });
    addChallengeBtn.addEventListener("click", () => {
      const txt = newChallengeInput.value.trim();
      if (!txt) return;
      const key = push(ref(db, "challenges")).key;
      const updates = {};
      updates[`challenges/${key}`] = { text: txt, author: me, ts: Date.now() };
      update(ref(db), updates);
      newChallengeInput.value = "";
    });
    function renderQuotes(qs) {
      quotesList.innerHTML = "";
      const arr = Object.entries(qs).sort((a,b)=>b[1].ts - a[1].ts);
      arr.forEach(([k,v]) => {
        const el = document.createElement("div");
        el.style.display = "flex";
        el.style.justifyContent = "space-between";
        el.style.alignItems = "center";
        el.style.padding = "6px 0";
        el.innerHTML = `<div class="small">"${v.text}" <span style="opacity:.6">‚Äî ${v.author}</span></div>
                        <div>
                          <button data-key="${k}" class="useQuote">Use</button>
                          <button data-key="${k}" class="delQuote" style="background:rgba(255,255,255,0.03)">Delete</button>
                        </div>`;
        quotesList.appendChild(el);
      });
      document.querySelectorAll(".useQuote").forEach(b => b.addEventListener("click", (e) => {
        const key = e.target.dataset.key;
        // set as today's quote (store under /meta/todayQuote)
        onValue(ref(db, `quotes/${key}`), (snap) => {
          const val = snap.val();
          if (val) set(ref(db, "meta/todayQuote"), val);
        }, { onlyOnce: true });
      }));
      document.querySelectorAll(".delQuote").forEach(b => b.addEventListener("click", (e) => {
        const key = e.target.dataset.key;
        if (confirm("Delete quote?")) remove(ref(db, `quotes/${key}`));
      }));
    }
    function renderChallenges(cs) {
      challengesList.innerHTML = "";
      const arr = Object.entries(cs).sort((a,b)=>b[1].ts - a[1].ts);
      arr.forEach(([k,v]) => {
        const el = document.createElement("div");
        el.style.display = "flex";
        el.style.justifyContent = "space-between";
        el.style.alignItems = "center";
        el.style.padding = "6px 0";
        el.innerHTML = `<div class="small">${v.text} <span style="opacity:.6">‚Äî ${v.author}</span></div>
                        <div>
                          <button data-key="${k}" class="useChallenge">Use</button>
                          <button data-key="${k}" class="delChallenge" style="background:rgba(255,255,255,0.03)">Delete</button>
                        </div>`;
        challengesList.appendChild(el);
      });
      document.querySelectorAll(".useChallenge").forEach(b => b.addEventListener("click", (e) => {
        const key = e.target.dataset.key;
        onValue(ref(db, `challenges/${key}`), (snap) => {
          const val = snap.val();
          if (val) set(ref(db, "meta/todayChallenge"), val);
        }, { onlyOnce: true });
      }));
      document.querySelectorAll(".delChallenge").forEach(b => b.addEventListener("click", (e) => {
        const key = e.target.dataset.key;
        if (confirm("Delete challenge?")) remove(ref(db, `challenges/${key}`));
      }));
    }
    // load today's quote/challenge from meta if set, else random fallback from seeded lists
    const seededQuotes = [
      "Love is not what you say, it's what you do.",
      "Even on quiet days, I choose you.",
      "Every storm ends with your smile.",
      "You're my home in every season."
    ];
    const seededChallenges = [
      "Send one message that‚Äôll make them think about you all day.",
      "Describe your perfect ‚Äòvirtual date‚Äô in detail.",
      "Give them a compliment that makes them blush a little."
    ];
    function loadQuote() {
      onValue(ref(db, "meta/todayQuote"), (snap) => {
        const val = snap.val();
        quoteEl.textContent = val ? `"${val.text}" ‚Äî ${val.author}` : `"${seededQuotes[Math.floor(Math.random()*seededQuotes.length)]}"`;
      });
    }
    function loadChallenge() {
      onValue(ref(db, "meta/todayChallenge"), (snap) => {
        const val = snap.val();
        challengeEl.textContent = val ? `${val.text} ‚Äî ${val.author}` : seededChallenges[Math.floor(Math.random()*seededChallenges.length)];
      });
    }
    // initial seed: if no quotes/challenges exist, write defaults (non-destructive)
    (async function seedIfEmpty(){
      onValue(ref(db, "quotes"), (snap) => {
        if (!snap.exists()) {
          const updates = {};
          seededQuotes.forEach(q => {
            const k = push(ref(db, "quotes")).key;
            updates[`quotes/${k}`] = { text: q, author: "system", ts: Date.now() };
          });
          update(ref(db), updates);
        }
      }, { onlyOnce: true });
      onValue(ref(db, "challenges"), (snap) => {
        if (!snap.exists()) {
          const updates = {};
          seededChallenges.forEach(c => {
            const k = push(ref(db, "challenges")).key;
            updates[`challenges/${k}`] = { text: c, author: "system", ts: Date.now() };
          });
          update(ref(db), updates);
        }
      }, { onlyOnce: true });
    })();
    // Close dropdown-like modals on outside click (for completeness)
    document.addEventListener("click", (e) => {
      if (!e.target.closest(".dropdown")) {
        document.querySelectorAll(".dropdown-list").forEach(list => list.classList.remove("show"));
      }
    });
    // Dog clicker sound
    function playClicks(n, delay = 300) {
      for (let i = 0; i < n; i++) {
        setTimeout(() => {
          const audio = new Audio(CLICK_SOUND_URL);
          audio.volume = localVolume;
          audio.play();
          document.body.classList.add("pop");
          setTimeout(() => document.body.classList.remove("pop"), 200);
        }, i * delay);
      }
    }
    function initClicker() {
      const buttons = {
        test: { btn: testBtn, clicks: 1 },
        bed: { btn: bedBtn, clicks: 2 },
        knees: { btn: kneesBtn, clicks: 3 },
        puppy: { btn: puppyBtn, clicks: 5 }
      };
      Object.entries(buttons).forEach(([type, {btn}]) => {
        btn.addEventListener("click", () => triggerClick(type, btn));
      });
    }
    function triggerClick(type, btn) {
      if (cooldownTimers[type]) return;
      btn.classList.add("shake");
      setTimeout(() => btn.classList.remove("shake"), 500);
      set(ref(db, "clicker/command"), { type, ts: Date.now(), sender: me });
      startCooldown(type, btn);
    }
    function startCooldown(type, btn) {
      let timeLeft = COOLDOWN_TIME;
      btn.disabled = true;
      btn.classList.add("disabled");
      const cooldownSpan = document.createElement("span");
      cooldownSpan.className = "cooldown";
      cooldownSpan.textContent = `${timeLeft}s‚Ä¶`;
      btn.appendChild(cooldownSpan);
      cooldownTimers[type] = setInterval(() => {
        timeLeft--;
        cooldownSpan.textContent = `${timeLeft}s‚Ä¶`;
        if (timeLeft <= 0) {
          clearInterval(cooldownTimers[type]);
          delete cooldownTimers[type];
          btn.disabled = false;
          btn.classList.remove("disabled");
          cooldownSpan.remove();
        }
      }, 1000);
    }
    // Volume
    function initVolume() {
      volumeSlider.value = localVolume;
      volumeValue.textContent = `${Math.round(localVolume * 100)}%`;
      volumeSlider.addEventListener("input", () => {
        localVolume = parseFloat(volumeSlider.value);
        volumeValue.textContent = `${Math.round(localVolume * 100)}%`;
        localStorage.setItem(`zlVolume_${me}`, localVolume);
      });
    }
    // Presence
    function setupPresence() {
      const presenceRef = ref(db, `presence/${me}`);
      set(presenceRef, true);
      onDisconnect(presenceRef).set(false);
    }
    // Extra: when unloading, clear typing flag
    window.addEventListener("beforeunload", () => {
      if (me) {
        update(ref(db, `chat/typing/${me}`), null);
        set(ref(db, `presence/${me}`), false);
      }
    });
    // Kickstart minimal display after short delay
    setTimeout(()=> {
      document.querySelectorAll(".tab[data-tab='dashboard']")[0]?.click();
    }, 400);
    // Note: everything uses Firebase's update/set/remove APIs ‚Äî no local 'update' wrapper to conflict.
  </script>
</body>
</html>

